<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PNG(16x16) to Shader Editor</title>
<style>
:root{
  --bg:#0f1720;
  --card:#0b1220;
  --accent:#9ad66b;
  --text:#e6eef7;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:var(--text);background:linear-gradient(180deg,#071018 0%, #0b1220 100%);-webkit-font-smoothing:antialiased}
.container{max-width:980px;margin:28px auto;padding:20px;background:rgba(255,255,255,0.02);border-radius:12px}
h1{margin:0 0 14px;font-size:20px;color:var(--accent)}
.file-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.file-row input[type=file]{display:inline-block}
.controls{display:flex;gap:8px;margin-bottom:12px}
button{background:#1f2a36;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
button:disabled{opacity:0.45;cursor:default}
.preview-row{display:flex;gap:16px;align-items:flex-start}
.preview-box{display:flex;flex-direction:column;align-items:center;gap:8px;width:280px}
.preview-box img{width:256px;height:256px;image-rendering:pixelated;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#222}
.note{font-size:12px;color:#9fb1c9;margin:0}
.shader-box{flex:1}
.shader-output{white-space:pre-wrap;background:#07121a;padding:12px;border-radius:8px;min-height:256px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
</style>
</head>
<body>
  <main class="container">
    <h1>PNG(16x16) to Shader Editor</h1>

    <label class="file-row">
      <span>Select PNG 16x16</span>
      <input id="file" type="file" accept="image/png">
    </label>

    <div class="controls">
      <a id="downloadShader" download="" style="text-decoration:none">
        <button id="btnShader" disabled>Download Shader (.frag)</button>
      </a>
      <a id="downloadPreview" download="" style="text-decoration:none">
        <button id="btnPreview" disabled>Download Preview (PNG)</button>
      </a>
    </div>

    <section class="preview-row">
      <div class="preview-box">
        <img id="previewImg" alt="preview" width="256" height="256">
        <p class="note">Preview</p>
      </div>

      <div class="shader-box">
        <pre id="out" class="shader-output" spellcheck="false"></pre>
      </div>
    </section>

  </main>

<script>
const fileInput = document.getElementById('file');
const out = document.getElementById('out');
const previewImg = document.getElementById('previewImg');
const downloadShader = document.getElementById('downloadShader');
const downloadPreview = document.getElementById('downloadPreview');
const btnShader = document.getElementById('btnShader');
const btnPreview = document.getElementById('btnPreview');

function toFixed6(n){ return (n/255).toFixed(6); }

function buildShaderFromImage(imgName, img16Data) {
  const lines = [];
  for(let y=0;y<16;y++){
    for(let x=0;x<16;x++){
      const i = (y*16 + x) * 4;
      let r = img16Data[i], g = img16Data[i+1], b = img16Data[i+2], a = img16Data[i+3];
      if(a < 255){
        const af = a/255;
        r = Math.round(r*af);
        g = Math.round(g*af);
        b = Math.round(b*af);
      }
      const comma = (y*16 + x) < 255 ? "," : "";
      lines.push("  vec3(" + toFixed6(r) + ", " + toFixed6(g) + ", " + toFixed6(b) + ")" + comma);
    }
  }

  const pixelsBlock = "const vec3 PIXELS[256] = vec3[256](\n" + lines.join("\n") + "\n);";

  const shader = [
    "#version 300 es",
    "precision mediump float;",
    "precision mediump int;",
    "out vec4 fragColor;",
    "uniform vec2 resolution;",
    pixelsBlock,
    "void main(){",
    "  vec2 uv=(gl_FragCoord.xy-vec2(0.5))/resolution;",
    "  int ix=int(clamp(floor(uv.x*16.0),0.0,15.0));",
    "  int iy=int(clamp(floor(uv.y*16.0),0.0,15.0));",
    "  int row_top=15-iy;",
    "  int idx=row_top*16+ix;",
    "  vec3 col=PIXELS[idx];",
    "  fragColor=vec4(col,1.0);",
    "}"
  ].join("\n");

  return shader;
}

function createPreviewBlob(img16Canvas){
  const up = document.createElement('canvas');
  up.width = 256; up.height = 256;
  const ctx = up.getContext('2d');
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(img16Canvas, 0, 0, 16, 16, 0, 0, 256, 256);
  return new Promise(resolve => up.toBlob(resolve, 'image/png'));
}

fileInput.addEventListener('change', () => {
  const f = fileInput.files[0];
  if(!f) return;
  const img = new Image();
  const reader = new FileReader();
  reader.onload = e => img.src = e.target.result;
  reader.readAsDataURL(f);

  img.onload = async () => {
    const tmp = document.createElement('canvas');
    tmp.width = img.width; tmp.height = img.height;
    const tctx = tmp.getContext('2d', {alpha: true});
    tctx.drawImage(img, 0, 0);

    const c = document.createElement('canvas');
    c.width = 16; c.height = 16;
    const ctx = c.getContext('2d', {alpha: true});
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(tmp, 0, 0, tmp.width, tmp.height, 0, 0, 16, 16);

    const imgData = ctx.getImageData(0,0,16,16).data;

    const shader = buildShaderFromImage(f.name, imgData);
    out.textContent = shader;

    const previewCanvas = document.createElement('canvas');
    previewCanvas.width = 256; previewCanvas.height = 256;
    const pctx = previewCanvas.getContext('2d');
    pctx.imageSmoothingEnabled = false;
    pctx.drawImage(c, 0, 0, 16, 16, 0, 0, 256, 256);
    previewImg.src = previewCanvas.toDataURL('image/png');

    const shaderBlob = new Blob([shader], {type: 'text/plain'});
    const shaderUrl = URL.createObjectURL(shaderBlob);
    downloadShader.href = shaderUrl;
    downloadShader.download = f.name.replace(/\.[^.]+$/, '') + "_16x16.frag";
    btnShader.disabled = false;

    const previewBlob = await createPreviewBlob(c);
    const prevUrl = URL.createObjectURL(previewBlob);
    downloadPreview.href = prevUrl;
    downloadPreview.download = f.name.replace(/\.[^.]+$/, '') + "_preview_256.png";
    btnPreview.disabled = false;
  };
});
</script>
</body>
</html>
